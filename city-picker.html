<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ÁúÅÂ∏ÇÂå∫ÈÄâÊã©</title>
  <style>
    select { margin: 5px; padding: 5px; width: 120px; }
  </style>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>
<body>
  <label>ÁúÅÔºö
    <select id="province"></select>
  </label>
  <label>Â∏ÇÔºö
    <select id="city"></select>
  </label>
  <label>Âå∫Ôºö
    <select id="area"></select>
  </label>

  <script>
    const dataUrl = "https://your-username.github.io/city-picker/list.json"; // üëà ‰øÆÊîπ‰∏∫‰Ω†ÁöÑ GitHub Pages ÈìæÊé•
    let regionData = {};

    function isDirectCity(code) {
      return ['11', '12', '31', '50'].includes(code.slice(0, 2));
    }

    function loadOptions($select, items) {
      $select.empty();
      items.forEach(item => {
        $select.append(`<option value="${item.code}">${item.name}</option>`);
      });
    }

    function getChildren(parentCode, level) {
      return Object.entries(regionData)
        .filter(([code]) => {
          if (level === 'province') return code.endsWith('0000');
          if (level === 'city') return (
            code.startsWith(parentCode.slice(0, 2)) &&
            code.endsWith('00') &&
            code !== parentCode &&
            !code.endsWith('0000')
          );
          if (level === 'area') return (
            code.startsWith(parentCode.slice(0, 4)) &&
            !code.endsWith('00')
          );
        })
        .map(([code, name]) => ({ code, name }));
    }

    $(async function () {
      const res = await fetch(dataUrl);
      regionData = await res.json();

      const provinces = getChildren('', 'province');
      loadOptions($('#province'), provinces);
      $('#province').trigger('change');

      $('#province').on('change', function () {
        const provCode = this.value;

        if (isDirectCity(provCode)) {
          const cityName = regionData[provCode];
          const districts = getChildren(provCode, 'area');

          loadOptions($('#city'), [{ code: provCode, name: cityName }]);
          loadOptions($('#area'), districts);
        } else {
          const cities = getChildren(provCode, 'city');
          loadOptions($('#city'), cities);
          $('#city').trigger('change');
        }
      });

      $('#city').on('change', function () {
        const cityCode = this.value;

        if (isDirectCity(cityCode)) return;

        const areas = getChildren(cityCode, 'area');
        loadOptions($('#area'), areas);
      });

      // JotForm communication
      JFCustomWidget.subscribe("submit", function () {
        const provinceName = $('#province option:selected').text();
        const cityName = $('#city option:selected').text();
        const areaName = $('#area option:selected').text();

        JFCustomWidget.sendSubmit({
          valid: true,
          value: {
            province: provinceName,
            city: cityName,
            area: areaName
          }
        });
      });
    });
  </script>
</body>
</html>
